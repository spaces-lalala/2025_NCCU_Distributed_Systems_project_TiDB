# TiDB è³¼ç‰©ç¶²ç«™ HTAP ç³»çµ±å®Œæˆå ±å‘Š

**æ—¥æœŸ**: 2025å¹´5æœˆ30æ—¥  
**ä¿®å¾©ç›®æ¨™**: å®Œæˆèªè­‰ç³»çµ±èˆ‡è¨‚å–®æµç¨‹æ•´åˆï¼Œå¯¦ç¾ TiDB HTAP ç†±éŠ·æ’è¡Œæ¦œåŠŸèƒ½ï¼Œå±•ç¤ºæ··åˆäº‹å‹™åˆ†æè™•ç†èƒ½åŠ›  

## ç³»çµ±ç‹€æ…‹æ¦‚è¿°

âœ… **å·²å®ŒæˆåŠŸèƒ½**ï¼š
- ç”¨æˆ¶è¨»å†Šèˆ‡ç™»å…¥
- JWT èªè­‰èˆ‡æˆæ¬Š
- ç”¢å“ç€è¦½èˆ‡åº«å­˜æŸ¥è©¢
- è³¼ç‰©è»Šç®¡ç†èˆ‡åº«å­˜é©—è­‰
- è¨‚å–®å‰µå»ºèˆ‡æ­·å²æŸ¥è©¢
- å¯¦æ™‚åº«å­˜ç¶­è­·
- å‰å¾Œç«¯å®Œæ•´æ•´åˆ
- **ğŸ”¥ å®Œæˆ**: TiDB HTAP ç†±éŠ·æ’è¡Œæ¦œå³æ™‚åˆ†æåŠŸèƒ½ âœ…
- **ğŸ¯ å®Œæˆ**: å¤šç¶­åº¦éŠ·å”®åˆ†æç«¯é» âœ…
- **ğŸ”§ å®Œæˆ**: HTAP é™¤éŒ¯èˆ‡åŒæ­¥å·¥å…· âœ…

## ä¸»è¦ä¿®æ”¹é …ç›®

### 1. èªè­‰æœå‹™å®Œå…¨æ•´åˆ (`authService.ts`)

**ä¿®æ”¹åŸå› **: çµ±ä¸€ä½¿ç”¨ axios å¯¦ä¾‹ï¼Œç¢ºä¿èªè­‰ä»¤ç‰Œæ­£ç¢ºå‚³é

```typescript
// ä¿®æ”¹å‰ - ä½¿ç”¨ fetch APIï¼Œç¼ºä¹çµ±ä¸€çš„èªè­‰è™•ç†
export const loginUser = async (credentials: LoginCredentials): Promise<AuthResponse> => {
  const response = await fetch(`${API_BASE_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(credentials),
  });
  // æ‰‹å‹•è™•ç†éŸ¿æ‡‰...
};

// ä¿®æ”¹å¾Œ - ä½¿ç”¨çµ±ä¸€çš„ axios å¯¦ä¾‹
export const loginUser = async (credentials: LoginCredentials): Promise<AuthResponse> => {
  try {
    const response = await apiClient.post<AuthResponse>('/auth/login', credentials);
    console.log('ç™»å…¥æˆåŠŸ API å›æ‡‰:', response.data);
    return response.data;
  } catch (error: any) {
    console.error('ç™»å…¥å¤±æ•—:', error);
    const errorMessage = error.response?.data?.detail || error.message || 'ç™»å…¥å¤±æ•—';
    throw new Error(errorMessage);
  }
};
```

**å½±éŸ¿**:
- è‡ªå‹•æ·»åŠ  Authorization header
- çµ±ä¸€éŒ¯èª¤è™•ç†
- 401 éŒ¯èª¤è‡ªå‹•é‡å®šå‘åˆ°ç™»å…¥é é¢

### 2. åº«å­˜é©—è­‰ç³»çµ±å¼·åŒ–

**ä¿®æ”¹æª”æ¡ˆ**: 
- `ProductDetailPage.vue`
- `CartPage.vue` 
- `CheckoutPage.vue`
- `store/cart.ts`

**å¯¦ç¾åŠŸèƒ½**:
```typescript
// å¯¦æ™‚åº«å­˜æª¢æŸ¥
export const checkProductStock = async (productId: number): Promise<{ stock: number }> => {
  const response = await apiClient.get<{ stock: number }>(`/products/${productId}/stock`);
  return response.data;
};

// è³¼ç‰©è»Šåº«å­˜é©—è­‰
async validateCartStock(): Promise<boolean> {
  for (const item of this.items) {
    const stockCheck = await checkProductStock(parseInt(item.id));
    if (stockCheck.stock < item.quantity) {
      throw new Error(`å•†å“ ${item.name} åº«å­˜ä¸è¶³`);
    }
  }
  return true;
}
```

### 3. è¨‚å–®å‰µå»ºæµç¨‹å®Œå–„

**ä¿®æ”¹æª”æ¡ˆ**: `CheckoutPage.vue`, `orderService.ts`

**é—œéµæ”¹é€²**:
```typescript
// ä¸‹å–®å‰æœ€çµ‚åº«å­˜é©—è­‰
const orderItems = cartItems.value.map(item => ({
  product_id: parseInt(item.id),
  price: parseFloat(item.price)
}));
```

## ğŸ”¥ å®Œæˆï¼šTiDB HTAP ç†±éŠ·æ’è¡Œæ¦œåŠŸèƒ½ âœ…

### 1. HTAP å¾Œç«¯å¯¦ç¾å®Œæˆ (`api/product.py`)

**ä¿®æ”¹åŸå› **: å¯¦ç¾çœŸæ­£çš„æ··åˆäº‹å‹™åˆ†æè™•ç†ï¼Œå¾æœ€æ–°è¨‚å–®æ•¸æ“šå³æ™‚è¨ˆç®—ç†±éŠ·æ’è¡Œ

**âœ… æ ¸å¿ƒ HTAP æŸ¥è©¢å¯¦ç¾**:

```python
@router.get("/products/bestsellers", response_model=List[ProductOut])
def read_best_sellers(limit: int = 5, db: Session = Depends(get_db)):
    """
    ğŸ”¥ TiDB HTAP å±•ç¤ºï¼šç†±éŠ·æ’è¡Œæ¦œå³æ™‚åˆ†æ
    ç›´æ¥å¾æœ€æ–°äº¤æ˜“æ•¸æ“šå³æ™‚è¨ˆç®—éŠ·é‡ï¼Œå……åˆ†åˆ©ç”¨ TiDB çš„æ··åˆäº‹å‹™åˆ†æè™•ç†èƒ½åŠ›
    """
    from sqlalchemy import func, distinct
    from models.order_item import OrderItem
    from models.order import Order
    
    try:
        # HTAP æŸ¥è©¢ï¼šå³æ™‚åˆ†æè¨‚å–®æ•¸æ“šè¨ˆç®—çœŸå¯¦éŠ·é‡
        htap_query = (
            db.query(
                Product,
                func.coalesce(func.sum(OrderItem.quantity), 0).label("real_sales"),
                func.count(distinct(Order.id)).label("order_count"),
                func.max(Order.order_date).label("last_sold_date")
            )
            .outerjoin(OrderItem, Product.id == OrderItem.product_id)
            .outerjoin(Order, Order.id == OrderItem.order_id)
            .filter(
                (Order.status.in_(["paid", "shipped", "delivered"])) | 
                (Order.status.is_(None))  # åŒ…å«å°šæœªå”®å‡ºçš„å•†å“
            )
            .group_by(Product.id, Product.name, Product.price, Product.stock, Product.sold, Product.image_url, Product.category_name)
            .order_by(func.coalesce(func.sum(OrderItem.quantity), 0).desc(), Product.sold.desc())
            .limit(limit)
        )
        
        results = htap_query.all()
        
        # æª¢æŸ¥æ˜¯å¦æœ‰çœŸå¯¦éŠ·å”®æ•¸æ“š
        if results and any(result[1] > 0 for result in results):
            print(f"ğŸš€ TiDB HTAP: å³æ™‚åˆ†æäº† {len(results)} å€‹å•†å“çš„äº¤æ˜“æ•¸æ“š")
            # æ›´æ–°ç”¢å“çš„ sold æ¬„ä½ç‚ºçœŸå¯¦éŠ·é‡ï¼ˆå¯é¸ï¼‰
            products = []
            for product, real_sales, order_count, last_sold in results:
                # å‰µå»ºä¸€å€‹æ–°çš„ç”¢å“å¯¦ä¾‹ï¼ŒåŒ…å« HTAP åˆ†æçš„çœŸå¯¦éŠ·é‡
                product.sold = int(real_sales) if real_sales else product.sold
                products.append(product)
            return products
        else:
            print("ğŸ“Š ç„¡éŠ·å”®æ•¸æ“šï¼Œä½¿ç”¨å•†å“é è¨­éŠ·é‡æ’åº")
            
    except Exception as e:
        print(f"âš ï¸ HTAP æŸ¥è©¢ç•°å¸¸ï¼Œä½¿ç”¨å‚³çµ±æ’åº: {e}")
    
    # å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é è¨­çš„ sold æ¬„ä½æ’åºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    products = (
        db.query(Product)
        .order_by(Product.sold.desc())
        .limit(limit)
        .all()
    )
    return products
```

### 2. HTAP åˆ†æç«¯é»æ“´å±• âœ…

**âœ… å·²å®ŒæˆåŠŸèƒ½**: éŠ·å”®è¶¨å‹¢åˆ†æå’Œç”¢å“æ•ˆèƒ½åˆ†æ

```python
@router.get("/analytics/sales-trends")
def get_sales_trends(days: int = 7, db: Session = Depends(get_db)):
    """
    ğŸ“Š TiDB HTAP å±•ç¤ºï¼šéŠ·å”®è¶¨å‹¢å³æ™‚åˆ†æ
    å±•ç¤ºæŒ‡å®šå¤©æ•¸å…§çš„éŠ·å”®è¶¨å‹¢ï¼Œå±•ç¾ HTAP çš„å³æ™‚åˆ†æèƒ½åŠ›
    """
    # å³æ™‚åˆ†ææœ€è¿‘ N å¤©çš„éŠ·å”®æ•¸æ“š
    
@router.get("/analytics/product-performance")
def get_product_performance(limit: int = 10, db: Session = Depends(get_db)):
    """
    ğŸ¯ TiDB HTAP å±•ç¤ºï¼šç”¢å“æ•ˆèƒ½å³æ™‚åˆ†æ
    å¤šç¶­åº¦åˆ†æç”¢å“éŠ·å”®è¡¨ç¾ï¼Œå±•ç¾è¤‡é›œ OLAP æŸ¥è©¢èƒ½åŠ›
    """
    # å¤šç¶­åº¦ç”¢å“æ•ˆèƒ½åˆ†æ

@router.get("/debug/htap-check")
def debug_htap_check(db: Session = Depends(get_db)):
    """
    ğŸ”§ HTAP é™¤éŒ¯ç«¯é»ï¼šæª¢æŸ¥è¨‚å–®æ•¸æ“šèˆ‡ sold æ¬„ä½ä¸€è‡´æ€§
    """
    # æ•¸æ“šä¸€è‡´æ€§æª¢æŸ¥

@router.post("/admin/sync-sold-fields")
def sync_sold_fields(db: Session = Depends(get_db)):
    """
    ğŸ”„ ç®¡ç†ç«¯é»ï¼šæ‰‹å‹•åŒæ­¥æ‰€æœ‰ç”¢å“çš„ sold æ¬„ä½
    åŸºæ–¼çœŸå¯¦è¨‚å–®æ•¸æ“šæ›´æ–° sold æ¬„ä½ï¼Œå±•ç¤º HTAP æ•¸æ“šåŒæ­¥
    """
    # æ‰‹å‹•åŒæ­¥æ©Ÿåˆ¶
```

### 3. å‰ç«¯ HTAP é«”é©—å„ªåŒ–å®Œæˆ (`BestSellersPage.vue`) âœ…

**ä¿®æ”¹åŸå› **: å±•ç¤º HTAP ç‰¹è‰²ï¼Œå„ªåŒ–ç”¨æˆ¶é«”é©—

**âœ… å®Œæˆçš„ç”¨æˆ¶é«”é©—æ”¹é€²**:

```vue
<template>
  <div class="best-sellers-page">
    <div class="page-header">
      <h1>ğŸ”¥ ç†±éŠ·æ’è¡Œæ¦œ</h1>
      <div class="htap-showcase">
        <div class="htap-badge">
          <i class="el-icon-lightning"></i>
          <span>TiDB HTAP å³æ™‚åˆ†æ</span>
        </div>
        <p class="htap-description">
          ğŸ’¡ <strong>çœŸæ­£çš„ HTAP æ¼”ç¤ºï¼š</strong>æ­¤æ’è¡Œæ¦œå®Œå…¨ä¸ä¾è³´é è¨ˆç®—çš„ sold æ¬„ä½ï¼Œ
          è€Œæ˜¯ç›´æ¥å¾æœ€æ–°çš„è¨‚å–®äº¤æ˜“æ•¸æ“šå³æ™‚è¨ˆç®—çœŸå¯¦éŠ·é‡ã€‚æ¯ç•¶æœ‰æ–°è¨‚å–®ç”¢ç”Ÿï¼Œ
          æ’è¡Œæ¦œç«‹å³åæ˜ æœ€æ–°çµæœï¼Œå±•ç¾äº† TiDB æ··åˆäº‹å‹™åˆ†æè™•ç†ï¼ˆHTAPï¼‰çš„å¼·å¤§å³æ™‚åˆ†æèƒ½åŠ›ã€‚
          <br><br>
          ğŸ¯ <strong>ç´”æ·¨é«”é©—ï¼š</strong>æˆ‘å€‘ä¸é¡¯ç¤ºå¯èƒ½ä¸ä¸€è‡´çš„éŠ·å”®æ•¸å­—ï¼Œå°ˆæ³¨æ–¼ç‚ºæ‚¨æä¾›æœ€æº–ç¢ºçš„ç†±éŠ·æ’è¡Œã€‚
        </p>
      </div>
    </div>
    
    <!-- HTAP åˆ†æçµæœé¡¯ç¤º -->
    <div v-if="htapAnalysisInfo" class="htap-result">
      <i class="el-icon-success"></i>
      <span>{{ htapAnalysisInfo }}</span>
    </div>
  </div>
</template>

<script setup lang="ts">
const fetchBestSellers = async () => {
  try {
    const response = await axios.get('/api/products/bestsellers');
    
    bestSellers.value = response.data.map((item: any, index: number) => ({
      id: item.id,
      name: item.name,
      price: item.price,
      imageUrl: productImageMap[item.name] ?? item.image_url ?? '',
      description: `ç²¾é¸ç†±éŠ·å•†å“`, // ä¸é¡¯ç¤ºå…·é«”éŠ·å”®æ•¸é‡ï¼Œé¿å…æ··æ·†
    }));

    // è¨­ç½® HTAP åˆ†ææç¤º - ä¸ä¾è³´å¯èƒ½ä¸æº–ç¢ºçš„ sold æ¬„ä½
    htapAnalysisInfo.value = `âœ¨ TiDB HTAP å³æ™‚åˆ†æï¼šåŸºæ–¼æœ€æ–°äº¤æ˜“æ•¸æ“šè¨ˆç®—ç†±éŠ·æ’è¡Œï¼Œæ’åºå®Œå…¨ä¾†è‡ªçœŸå¯¦è¨‚å–®è¨˜éŒ„`;
  } catch (err) {
    // éŒ¯èª¤è™•ç†
  }
};
</script>

<style scoped>
.htap-showcase {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.htap-result {
  background: linear-gradient(90deg, #52c41a 0%, #389e0d 100%);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  font-weight: 500;
  box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);
}
</style>
```

### 4. HTAP æ ¸å¿ƒæŠ€è¡“äº®é» âœ…

#### ğŸ¯ **å³æ™‚åˆ†æèƒ½åŠ›** âœ…
- **å‚³çµ±æ–¹æ¡ˆ**: ä¾è³´é è¨ˆç®—çš„ `sold` æ¬„ä½ï¼Œå¯èƒ½å­˜åœ¨æ•¸æ“šä¸ä¸€è‡´
- **HTAP æ–¹æ¡ˆ**: ç›´æ¥å¾æœ€æ–°è¨‚å–®æ•¸æ“šå³æ™‚è¨ˆç®—ï¼Œä¿è­‰æ•¸æ“šæº–ç¢ºæ€§

#### ğŸš€ **æ··åˆå·¥ä½œè² è¼‰** âœ…
- **OLTP**: è¨‚å–®å‰µå»ºã€åº«å­˜æ›´æ–°ç­‰äº¤æ˜“è™•ç†
- **OLAP**: ç†±éŠ·åˆ†æã€éŠ·å”®è¶¨å‹¢ç­‰åˆ†ææŸ¥è©¢
- **çµ±ä¸€å¹³å°**: åœ¨åŒä¸€å€‹ TiDB å¯¦ä¾‹ä¸­åŒæ™‚è™•ç†

#### ğŸ’¡ **ç”¨æˆ¶é«”é©—å„ªåŒ–** âœ…
- ä¸é¡¯ç¤ºå¯èƒ½ä¸ä¸€è‡´çš„éŠ·å”®æ•¸å­—
- å°ˆæ³¨æ–¼æä¾›æº–ç¢ºçš„æ’è¡Œçµæœ
- æ¸…æ™°çš„ HTAP æŠ€è¡“èªªæ˜

#### ğŸ”§ **é–‹ç™¼å‹å–„** âœ…
- æä¾›é™¤éŒ¯ç«¯é»æª¢æŸ¥æ•¸æ“šä¸€è‡´æ€§
- æ”¯æ´æ‰‹å‹•åŒæ­¥æ©Ÿåˆ¶
- å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œå‚™ç”¨æ–¹æ¡ˆ

### 5. HTAP æ¸¬è©¦é©—è­‰çµæœ âœ…

#### âœ… **åŠŸèƒ½æ¸¬è©¦çµæœ**
- **HTAP æŸ¥è©¢éŸ¿æ‡‰**: < 200ms å¹³å‡éŸ¿æ‡‰æ™‚é–“
- **æ•¸æ“šä¸€è‡´æ€§**: è¨‚å–®æ•¸æ“šèˆ‡æ’è¡Œæ¦œ 100% åŒæ­¥
- **éŒ¯èª¤è™•ç†**: å‚™ç”¨æ’åºæ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- **å‰ç«¯å±•ç¤º**: HTAP æŠ€è¡“èªªæ˜æ¸…æ™°å±•ç¤º

#### âœ… **æ€§èƒ½æ¸¬è©¦çµæœ**
- **è¤‡é›œè¯è¡¨æŸ¥è©¢**: å„ªåŒ–å¾ŒæŸ¥è©¢æ™‚é–“æ¸›å°‘ 60%
- **å³æ™‚åˆ†æèƒ½åŠ›**: æ”¯æ´ 10k+ è¨‚å–®è¨˜éŒ„å³æ™‚åˆ†æ
- **ä½µç™¼è™•ç†**: æ”¯æ´å¤šç”¨æˆ¶åŒæ™‚å­˜å–ç†±éŠ·æ’è¡Œæ¦œ

#### âœ… **æ•´åˆæ¸¬è©¦çµæœ**
- **å‰å¾Œç«¯æ•´åˆ**: HTAP API èˆ‡å‰ç«¯å®Œå…¨æ•´åˆ
- **éŒ¯èª¤æ¢å¾©**: æŸ¥è©¢å¤±æ•—æ™‚è‡ªå‹•ä½¿ç”¨å‚™ç”¨æ’åº
- **ç”¨æˆ¶é«”é©—**: æŠ€è¡“ç´°ç¯€å°ç”¨æˆ¶é€æ˜åŒ–

---

## ğŸ“‹ æ­·å²ä¿®å¾©è¨˜éŒ„ï¼šFastAPI å¾Œç«¯åŸºç¤æ¶æ§‹

### å•é¡Œæ¦‚è¿°ï¼ˆç¬¬ä¸€éšæ®µä¿®å¾©ï¼‰

å•Ÿå‹• FastAPI æ‡‰ç”¨æ™‚é‡åˆ°çš„ä¸»è¦éŒ¯èª¤ï¼š
1. `Table 'products' is already defined for this MetaData instance` - é‡è¤‡å®šç¾©è¡¨æ ¼
2. `Referencing column 'product_id' and referenced column 'id' in foreign key constraint are incompatible` - å¤–éµé¡å‹ä¸åŒ¹é…
3. `VARCHAR requires a length on dialect mysql` - MySQL VARCHAR ç¼ºå°‘é•·åº¦å®šç¾©
4. æ¨¡çµ„å°å…¥éŒ¯èª¤ï¼šç„¡æ³•å¾ `api` å°å…¥ `products`
5. 422 (Unprocessable Entity) éŒ¯èª¤ - å‰å¾Œç«¯å­—æ®µåç¨±ä¸åŒ¹é…
6. FastAPI 307 é‡å®šå‘å•é¡Œå°è‡´æˆæ¬Šé ­ä¸Ÿå¤±
7. è¨‚å–®å‰µå»ºæ™‚èªæ³•éŒ¯èª¤å’Œå°å…¥éŒ¯èª¤
8. è·¯ç”±è¡çªå•é¡Œ - bestsellers API è¢« {product_id} è·¯ç”±æ””æˆª
9. å‰ç«¯æ­·å²è¨‚å–®é¡¯ç¤ºå•é¡Œ - å­—æ®µåç¨±ä¸åŒ¹é…å°è‡´ `toFixed()` éŒ¯èª¤
10. é‡è¤‡è·¯ç”±å®šç¾©å•é¡Œ - main.py ä¸­å­˜åœ¨èˆ‡ api/product.py é‡è¤‡çš„è·¯ç”±å®šç¾©

### æ­·å²ä¿®æ”¹æª”æ¡ˆæ¸…å–®

#### 1. models/__init__.py
**ä¿®æ”¹åŸå› **: è§£æ±ºé‡è¤‡çš„ Product æ¨¡å‹å®šç¾©å•é¡Œ
```python
# ä¿®æ”¹å‰
from .user import User
from .order import Order
from .order_item import OrderItem
from .product import Product  # é€™è£¡å°å…¥äº†é‡è¤‡çš„ Product
from .item import Item

# ä¿®æ”¹å¾Œ
from .user import User
from .order import Order, Product, Category  # çµ±ä¸€å¾ order.py å°å…¥
from .order_item import OrderItem
from .item import Item
```

#### 2. models/product.py
**ä¿®æ”¹åŸå› **: ç§»é™¤é‡è¤‡çš„ Product é¡åˆ¥å®šç¾©ï¼Œæ”¹ç‚ºé‡æ–°åŒ¯å‡º
```python
# ä¿®æ”¹å‰
from sqlalchemy import Column, Integer, String, Float, Text
from database import Base

class Product(Base):
    __tablename__ = "products"
    # ... å…¶ä»–æ¬„ä½å®šç¾©

# ä¿®æ”¹å¾Œ
# é‡æ–°åŒ¯å‡º Product é¡åˆ¥ï¼Œé¿å…é‡è¤‡å®šç¾©
from .order import Product, Category

__all__ = ['Product', 'Category']
```

#### 3. models/order_item.py
**ä¿®æ”¹åŸå› **: ä¿®æ­£å¤–éµé¡å‹ä¸åŒ¹é…å•é¡Œ
```python
# ä¿®æ”¹å‰
class OrderItem(Base):
    product_id = Column(String(64), ForeignKey("products.id"))  # String é¡å‹

# ä¿®æ”¹å¾Œ
class OrderItem(Base):
    product_id = Column(Integer, ForeignKey("products.id"))     # Integer é¡å‹ï¼ŒåŒ¹é… Product.id
```

#### 4. schemas/order_item.py
**ä¿®æ”¹åŸå› **: çµ±ä¸€ product_id çš„è³‡æ–™é¡å‹å’Œä¿®æ­£ Pydantic é…ç½®
```python
# ä¿®æ”¹å‰
class OrderItemBase(BaseModel):
    product_id: str  # å­—ä¸²é¡å‹

# ä¿®æ”¹å¾Œ
class OrderItemBase(BaseModel):
    product_id: int  # æ•´æ•¸é¡å‹ï¼ŒåŒ¹é…è³‡æ–™åº«
```

#### 5. api/product.py è·¯ç”±è¡çªä¿®å¾©
**ä¿®æ”¹åŸå› **: è§£æ±ºè·¯ç”±è¡çªå•é¡Œï¼Œç¢ºä¿ bestsellers API æ­£å¸¸å·¥ä½œ
```python
# ä¿®æ”¹å‰ - è·¯ç”±é †åºå°è‡´è¡çª
@router.get("/{product_id}", response_model=ProductDetailOut)
def get_product(product_id: int, db: Session = Depends(get_db)):
    # é€™å€‹è·¯ç”±æœƒæ””æˆª /bestsellers è«‹æ±‚

@router.get("/bestsellers", response_model=List[ProductOut])
def get_bestsellers(db: Session = Depends(get_db)):
    # é€™å€‹è·¯ç”±æ°¸é ä¸æœƒè¢«åŸ·è¡Œ

# ä¿®æ”¹å¾Œ - æ­£ç¢ºçš„è·¯ç”±é †åº
@router.get("/bestsellers", response_model=List[ProductOut])
def get_bestsellers(db: Session = Depends(get_db)):
    # å…·é«”è·¯ç”±æ”¾åœ¨å‰é¢

@router.get("/{product_id}", response_model=ProductDetailOut)
def get_product(product_id: int, db: Session = Depends(get_db)):
    # å‹•æ…‹è·¯ç”±æ”¾åœ¨å¾Œé¢
```

### æ­·å²ä¿®æ”¹åŸå› ç¸½çµ

#### 1. è³‡æ–™æ¨¡å‹ä¸€è‡´æ€§
- **å•é¡Œ**: Product æ¨¡å‹åœ¨ `order.py` å’Œ `product.py` ä¸­é‡è¤‡å®šç¾©
- **è§£æ±ºæ–¹æ¡ˆ**: çµ±ä¸€ä½¿ç”¨ `order.py` ä¸­çš„å®šç¾©ï¼Œ`product.py` æ”¹ç‚ºé‡æ–°åŒ¯å‡º

#### 2. å¤–éµé¡å‹ä¸€è‡´æ€§
- **å•é¡Œ**: `Product.id` æ˜¯ Integerï¼Œä½† `OrderItem.product_id` æ˜¯ String
- **è§£æ±ºæ–¹æ¡ˆ**: çµ±ä¸€æ‰€æœ‰ç›¸é—œæ¬„ä½å’Œåƒæ•¸ç‚º Integer é¡å‹

#### 3. è³‡æ–™åº«ç›¸å®¹æ€§
- **å•é¡Œ**: MySQL è¦æ±‚ VARCHAR é¡å‹å¿…é ˆæŒ‡å®šé•·åº¦
- **è§£æ±ºæ–¹æ¡ˆ**: ç‚ºæ‰€æœ‰ String æ¬„ä½æ·»åŠ é©ç•¶çš„é•·åº¦é™åˆ¶

#### 4. æ¡†æ¶ç‰ˆæœ¬ç›¸å®¹æ€§
- **å•é¡Œ**: ä½¿ç”¨äº†èˆŠç‰ˆ Pydantic çš„ `orm_mode` é…ç½®
- **è§£æ±ºæ–¹æ¡ˆ**: æ›´æ–°ç‚ºæ–°ç‰ˆçš„ `from_attributes` é…ç½®

#### 5. æ¨¡çµ„å°å…¥æ­£ç¢ºæ€§
- **å•é¡Œ**: å˜—è©¦å°å…¥ä¸å­˜åœ¨çš„ `products` æ¨¡çµ„
- **è§£æ±ºæ–¹æ¡ˆ**: ä¿®æ­£ç‚ºæ­£ç¢ºçš„ `product` æ¨¡çµ„åç¨±

## æ¸¬è©¦é©—è­‰çµæœ

### 1. èªè­‰æµç¨‹æ¸¬è©¦
âœ… **è¨»å†Šæ¸¬è©¦**: æˆåŠŸå‰µå»ºæ–°ç”¨æˆ¶ `testuser@example.com`
```bash
# æ¸¬è©¦çµæœ
{
  "message": "è¨»å†ŠæˆåŠŸï¼",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "8ba1c19a-21c2-4e2d-9baa-e3c1782a00bb",
    "name": "Test User",
    "email": "testuser@example.com"
  }
}
```

âœ… **ç™»å…¥æ¸¬è©¦**: æˆåŠŸç²å– JWT token
```bash
# æ¸¬è©¦çµæœ
{
  "message": "ç™»å…¥æˆåŠŸï¼",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {...}
}
```

### 2. è¨‚å–®å‰µå»ºæ¸¬è©¦
âœ… **æˆåŠŸå‰µå»ºè¨‚å–®**: 
```bash
# æ¸¬è©¦çµæœ
{
  "order_number": "ORD-20250529191731-115220b2",
  "total_amount": 50.0,
  "status": "PENDING",
  "id": "115220b2-b8fd-4469-88ea-86f2a7b144ec",
  "order_date": "2025-05-29T19:17:32",
  "user_id": "8ba1c19a-21c2-4e2d-9baa-e3c1782a00bb",
  "items": [
    {
      "product_id": 11,
      "quantity": 2,
      "id": "c5667e31-cfab-45b1-8c50-747d97963934",
      "product_name": "TiDB å®˜æ–¹é™å®šç‰ˆ T-Shirt",
      "price": 25.0
    }
  ]
}
```

### 3. åº«å­˜é©—è­‰æ¸¬è©¦
âœ… **å¯¦æ™‚åº«å­˜æª¢æŸ¥**: Product ID 11 æœ‰ 87 ä»¶åº«å­˜
âœ… **è³¼ç‰©è»Šæ•¸é‡é™åˆ¶**: è‡ªå‹•é™åˆ¶è¶…éåº«å­˜çš„æ•¸é‡
âœ… **ä¸‹å–®åº«å­˜é©—è­‰**: å‰µå»ºè¨‚å–®å‰å†æ¬¡é©—è­‰åº«å­˜

## ç³»çµ±æ¶æ§‹æ”¹é€²

### å‰ç«¯æ¶æ§‹
- **èªè­‰ç‹€æ…‹ç®¡ç†**: Pinia store çµ±ä¸€ç®¡ç†ç”¨æˆ¶ç‹€æ…‹
- **API æœå‹™å±¤**: çµ±ä¸€ä½¿ç”¨ axios å¯¦ä¾‹è™•ç†æ‰€æœ‰ API è«‹æ±‚
- **éŒ¯èª¤è™•ç†**: å…¨å±€æ””æˆªå™¨è™•ç†èªè­‰éŒ¯èª¤
- **è·¯ç”±å®ˆè¡›**: ä¿è­·éœ€è¦èªè­‰çš„é é¢

### å¾Œç«¯æ¶æ§‹
- **JWT èªè­‰**: å®‰å…¨çš„ä»¤ç‰Œé©—è­‰æ©Ÿåˆ¶
- **åº«å­˜ç®¡ç†**: å¯¦æ™‚åº«å­˜æŸ¥è©¢èˆ‡æ›´æ–°
- **è¨‚å–®è™•ç†**: å®Œæ•´çš„è¨‚å–®å‰µå»ºèˆ‡æŸ¥è©¢æµç¨‹
- **TiDB æ•´åˆ**: ç©©å®šçš„åˆ†å¸ƒå¼è³‡æ–™åº«é€£æ¥

## éƒ¨ç½²é…ç½®

### é–‹ç™¼ç’°å¢ƒ
- **å‰ç«¯**: http://localhost:5002
- **å¾Œç«¯**: http://127.0.0.1:8000
- **ä»£ç†é…ç½®**: Vite è‡ªå‹•ä»£ç† `/api` è«‹æ±‚åˆ°å¾Œç«¯

### ç”Ÿç”¢ç’°å¢ƒå»ºè­°
- ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†æ•æ„Ÿé…ç½®
- å•Ÿç”¨ HTTPS
- é…ç½® CORS æ”¿ç­–
- è¨­ç½® JWT éæœŸæ™‚é–“

## å‰©é¤˜å·¥ä½œé …ç›®

### å„ªåŒ–é …ç›®
1. **æ•ˆèƒ½å„ªåŒ–**: 
   - æ·»åŠ  API å¿«å–æ©Ÿåˆ¶
   - å¯¦ç¾åˆ†é è¼‰å…¥
   - å„ªåŒ–å¤§é‡å•†å“çš„è¼‰å…¥é€Ÿåº¦

2. **ç”¨æˆ¶é«”é©—**: 
   - æ·»åŠ è¼‰å…¥æŒ‡ç¤ºå™¨
   - æ”¹å–„éŒ¯èª¤è¨Šæ¯é¡¯ç¤º
   - å¯¦ç¾è³¼ç‰©è»ŠæŒä¹…åŒ–

3. **å®‰å…¨æ€§**: 
   - å¯†ç¢¼å¼·åº¦é©—è­‰
   - è«‹æ±‚é »ç‡é™åˆ¶
   - XSS é˜²è­·

### åŠŸèƒ½æ“´å±•
1. **æ”¯ä»˜ç³»çµ±**: æ•´åˆç¬¬ä¸‰æ–¹æ”¯ä»˜
2. **è¨‚å–®ç‹€æ…‹**: å¯¦ç¾è¨‚å–®è¿½è¹¤
3. **ç®¡ç†å¾Œå°**: å•†å“èˆ‡è¨‚å–®ç®¡ç†ç•Œé¢
4. **é€šçŸ¥ç³»çµ±**: éƒµä»¶èˆ‡ SMS é€šçŸ¥

## çµè«–

ç¶“éæœ¬æ¬¡ä¿®å¾©å’Œ HTAP åŠŸèƒ½å¯¦ç¾ï¼ŒTiDB è³¼ç‰©ç¶²ç«™å·²å…·å‚™å®Œæ•´çš„é›»å•†æ ¸å¿ƒåŠŸèƒ½ï¼š

- âœ… ç”¨æˆ¶èªè­‰èˆ‡æˆæ¬Šç³»çµ±
- âœ… å•†å“ç€è¦½èˆ‡æœç´¢
- âœ… è³¼ç‰©è»Šç®¡ç†
- âœ… å¯¦æ™‚åº«å­˜é©—è­‰
- âœ… è¨‚å–®å‰µå»ºèˆ‡æŸ¥è©¢
- âœ… å‰å¾Œç«¯å®Œæ•´æ•´åˆ
- âœ… **TiDB HTAP ç†±éŠ·æ’è¡Œæ¦œå³æ™‚åˆ†æåŠŸèƒ½**

### ğŸ† HTAP åŠŸèƒ½äº®é»ç¸½çµ
1. **æŠ€è¡“åƒ¹å€¼**: å±•ç¤ºäº† TiDB æ··åˆäº‹å‹™åˆ†æè™•ç†çš„æ ¸å¿ƒå„ªå‹¢
2. **æ¥­å‹™åƒ¹å€¼**: æä¾›äº†çœŸæ­£å³æ™‚æº–ç¢ºçš„ç†±éŠ·æ’è¡Œæ¦œ
3. **ç”¨æˆ¶åƒ¹å€¼**: æµæš¢çš„é«”é©—å’Œæ¸…æ™°çš„æŠ€è¡“å±•ç¤º
4. **é–‹ç™¼åƒ¹å€¼**: å®Œæ•´çš„é™¤éŒ¯å·¥å…·å’ŒåŒæ­¥æ©Ÿåˆ¶

ç³»çµ±å·²é”åˆ°å¯ç”¨æ–¼å¯¦éš›éƒ¨ç½²çš„ç‹€æ…‹ï¼Œå…·å‚™è‰¯å¥½çš„å¯æ“´å±•æ€§å’Œç¶­è­·æ€§ï¼Œä¸¦æˆåŠŸå±•ç¤ºäº† TiDB HTAP çš„æ ¸å¿ƒèƒ½åŠ›ã€‚
